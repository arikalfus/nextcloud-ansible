---

- name: PHP | Check if Remi Repository is installed
  become: yes
  command: rpm -q remi-release-7.3-2.el7.remi.noarch
  changed_when: false
  failed_when: false
  when: ansible_distribution == "CentOS"
  register: remi_installed

- name: PHP | Install Remi Repository
  become: yes
  command: rpm -Uvh http://rpms.remirepo.net/enterprise/remi-release-7.rpm
  when: remi_installed.stdout != "remi-release-7.3-2.el7.remi.noarch"
  register: php_remi

- name: PHP | Set PHP version to 7.1
  become: yes
  command: yum-config-manager --enable remi-php71
  when: php_remi.changed

  # https://docs.nextcloud.com/server/12/admin_manual/installation/source_installation.html#prerequisites-for-manual-installation
- name: PHP | Install PHP
  become: yes
  yum: update_cache=yes name={{ item }} state=latest
  with_items:
    - php-fpm
    - php-cli
    - php-opcache
    - php-ctype
    - php-dom
    - php-gd
    - php-iconv
    - php-json
    - php-libxml
    - php-mbstring
    - php-posix
    - php-simplexml
    - php-xmlreader
    - php-xmlwriter
    - php-zip
    - php-zlib
    - php-pdo_mysql
    - php-curl
    - php-fileinfo
    - php-bz2
    - php-intl
    - php-mcrypt
    - php-openssl
    - php-pcntl
    - php-redis
  when: ansible_distribution == "CentOS"
  notify:
    - Nginx Reload
    - PHP Reload

- name: PHP | Copy PHP configuration
  become: yes
  copy:
    src: files/php/www.conf
    dest: /etc/php-fpm.d/www.conf
    owner: nginx
    group: nginx
    mode: 0644
  notify: PHP Reload

- name: PHP | Create session directory
  file: path=/var/lib/php/session state=directory owner=nginx group=nginx

- name: PHP | Start PHP service
  become: yes
  service: name=php-fpm enabled=yes state=started
